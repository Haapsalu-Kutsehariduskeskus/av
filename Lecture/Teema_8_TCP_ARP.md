# Teema 8: TCP/IP protokolli √ºlevaade. Kuidas ARP t√∂√∂tab.

## Sissejuhatus
TCP/IP protokollide kogum on v√µrgusuhtluse selgroog, mida kasutatakse laialdaselt interneti ja kohalike v√µrkude toimimiseks. Selle loengu k√§igus tutvume TCP/IP st√§ki p√µhielementidega, sealhulgas andmepakettide struktuuri, nende edastamise ja juhtimise protsessidega.

TCP/IP st√§kk koosneb mitmest kihist, millest iga√ºhel on kindel roll v√µrgusuhtluse tagamisel. N√§iteks rakendustasandi protokollid, nagu HTTP ja FTP, vastutavad kasutajarakenduste suhtluse eest, samas kui v√µrgu- ja transporditasandi protokollid, nagu IP ja TCP, tagavad andmete edastamise v√µrgu kaudu.

---

## TCP/IP st√§kk ja p√µhiprotokollid

TCP/IP st√§kk koosneb neljast p√µhikihist:
| Kiht | Kirjeldus | Protokollid |
|------|-----------|-------------|
| Rakendustase | Vastutab kasutajarakenduste ja teenuste eest | HTTP, FTP, DNS |
| Transporditase | Hoolitseb andmeedastuse usaldusv√§√§rsuse ja vigade parandamise eest | TCP, UDP |
| V√µrgutase | Juhib pakettide marsruutimist ja aadressimist | IP |
| Linktase | Tagab andmete edastamise √ºhes v√µrgu segmendis | Ethernet, ARP |

---

## Inkapsulatsioon

Inkapsulatsioon on protsess, mille k√§igus lisatakse iga kihi andmetele vastav p√§is (header), et need saaksid √µigesti edastatud ja tuvastatud.

![TCP/IP Inkapsulatsioon](https://miro.medium.com/v2/resize:fit:720/format:webp/1*rGq90RkwhngwAJ0l5vo91w.png)

N√§ide inkapsulatsioonist:
1. **Etherneti kaader** sisaldab l√§hte- ja sihtkoha MAC-aadresse
2. **IP-pakett** sisaldab l√§hte- ja sihtkoha IP-aadresse ning muid metaandmeid
3. **TCP v√µi UDP segment** tagab andmete transpordi rakenduste vahel
4. Andmed edastatakse f√º√ºsilise v√µrgu kaudu, kus iga kiht eemaldab saadud paketi p√§ise ja t√∂√∂tleb sisu vastavalt oma funktsioonidele
---

## ARP (Address Resolution Protocol)
ARP on h√§davajalik protokoll, mis teisendab IP-aadressid f√º√ºsilisteks MAC-aadressideks. See protsess on vajalik, kuna Etherneti protokoll kasutab suhtlemiseks MAC-aadresse.

## ARP t√∂√∂p√µhim√µte
1. Kui seade soovib saata andmeid, kuid ei tea sihtkoha MAC-aadressi, saadab ta ARP-p√§ringu (broadcast): "Kes on IP-aadressiga X?"
2. Sihtseade vastab: "Mina olen IP-aadress X ja minu MAC-aadress on Y."
3. Vastus salvestatakse ARP-tabelisse teatud ajaks, et v√§ltida pidevaid p√§ringuid.

![ARP Diagram](https://www.flackbox.com/wp-content/uploads/2020/07/word-image-5-8.webp)
*Image Source: [ARP ‚Äì The Address Resolution Protocol](https://www.flackbox.com/arp-the-address-resolution-protocol)*


## ARP probleemid ja lahendused

V√µrguliikluse t√∂√∂kindluse tagamisel on oluline m√µista ja lahendada ARP-ga seotud probleeme:

**ARP vastuse puudumine**
- Kui seade ei saa ARP vastust, j√§√§b andmepaketi saatmine ootele
- P√µhjuseks on puuduv teave sihtkoha seadme MAC-aadressi kohta
- Lahendus: kontrollige v√µrgu√ºhendusi ja sihtseadme olekut

**IP-aadresside konfliktid** 
- Sama IP-aadressi kasutamine mitme seadme poolt p√µhjustab ebastabiilsust
- "Graceful ARP" mehhanism aitab konflikte automaatselt tuvastada
- Seadmed saavad probleemi avastamisel kohe reageerida ja olukorra lahendada

**Ebatavalised ARP vastused**
- Mitme erineva MAC-aadressi sidumine √ºhe IP-ga viitab probleemidele
- V√µib olla m√§rk ARP spoofingust v√µi valesti seadistatud seadmetest
- Vajalik v√µrguliikluse monitooring ja turvameetmete rakendamine

## ARP Suhtlusprotsess

```mermaid
sequenceDiagram
    participant A as Arvuti A<br/>(IP: 192.168.1.2)
    participant V as V√µrk (Broadcast)
    participant B as Arvuti B<br/>(IP: 192.168.1.1)
    
    Note over A,B: ARP P√§ring ja Vastus
    A->>V: ARP P√§ring (Broadcast)<br/>Kes omab IP 192.168.1.1?
    V->>B: Broadcast edastatakse
    B->>A: ARP Vastus (Unicast)<br/>MAC: AA:BB:CC:DD:EE:FF

    Note over A,B: ARP Probleem - Vastus Puudub
    A->>V: ARP P√§ring
    V->>B: Broadcast
    Note over B: Seade v√§ljas v√µi<br/>ei vasta
    Note over A: Andmepaketti ei<br/>saa saata
```

## ARP ja RARP paketi formaat

```mermaid
classDiagram
    class ARPPakett {
        +P√§is
        +Sisuv√§ljad
    }
    
    class P√§is {
        +Riistvara t√º√ºp (Ethernet)
        +Protokolli t√º√ºp (IPv4)
        +MAC aadressi pikkus
        +IP aadressi pikkus
        +Operatsiooni kood
    }
    
    class Sisuv√§ljad {
        +L√§hte MAC aadress
        +L√§hte IP aadress
        +Sihtkoha MAC aadress
        +Sihtkoha IP aadress
    }
    
    ARPPakett *-- P√§is
    ARPPakett *-- Sisuv√§ljad
```

## ARP-pakett

**P√§ise komponendid:**
- Protokolli t√º√ºbi info (nt Ethernet, IPv4)
- Kasutatavate aadresside t√º√ºbid (MAC ja IP)

**Sisuv√§ljad:**
- L√§hte MAC-aadress: Saatja f√º√ºsiline v√µrguaadress
- L√§hte IP-aadress: Saatja IP-aadress 
- Sihtkoha MAC-aadress: ARP p√§ringus t√ºhi v√§li
- Sihtkoha IP-aadress: Otsitava seadme IP-aadress

### ARP Probleemide √úlevaade

```mermaid
graph TD
    A[ARP Probleemid] --> B[ARP vastus puudub]
    A --> C[IP konflikt]
    A --> D[Kahtlased ARP vastused]
    
    B --> B1[Andmepakett ei liigu edasi]
    B --> B2[MAC aadress puudub]
    
    C --> C1[Sama IP mitmel seadmel]
    C --> C2[Graceful ARP tuvastab]
    
    D --> D1[Mitu MAC aadressi<br/>√ºhe IP kohta]
    D --> D2[V√µimalik ARP spoofing]
    
    style A fill:#f9f,stroke:#333,stroke-width:4px
    style B fill:#bbf,stroke:#333
    style C fill:#bbf,stroke:#333
    style D fill:#bbf,stroke:#333
```

## T√∂√∂mehhanismid

**ARP p√§ring (request):**
- Saadetakse broadcast-s√µnumina kogu v√µrku
- K√ºsimus: "Kes on selle IP-aadressi omanik?"

**ARP vastus (reply):**
- Saadetakse unicast-s√µnumina otse p√§rijale
- Sisaldab k√ºsitud IP-le vastavat MAC-aadressi

## RARP-pakett

RARP (Reverse Address Resolution Protocol) v√µimaldab MAC-aadressi p√µhjal IP-aadressi m√§√§ramist:

**P√µhiv√§ljad:**
- L√§hte MAC-aadress: IP-aadressi vajava seadme f√º√ºsiline aadress
- Sihtkoha MAC-aadress: IP-aadresse m√§√§rava RARP serveri aadress

## Praktiline n√§ide

ARP suhtlus v√µrgus:

```
# ARP p√§ring (broadcast):
Who has 192.168.1.1? Tell 192.168.1.2

# ARP vastus (unicast): 
192.168.1.1 is at AA:BB:CC:DD:EE:FF
```

![ARP Request](https://www.practicalnetworking.net/wp-content/uploads/2017/01/traditional-arp-request-ethernet-600x118.png)  
*Image Source: [Practical Networking - ARP Request](https://www.practicalnetworking.net/stand-alone/arp-request-reply/)*

![ARP Response](https://www.practicalnetworking.net/wp-content/uploads/2017/01/traditional-arp-response-ethernet-600x118.png)  
*Image Source: [Practical Networking - ARP Response](https://www.practicalnetworking.net/stand-alone/arp-request-reply/)*


### ARP - The Address Resolution Protocol (Video)

[![ARP Explanation Video](https://img.youtube.com/vi/Cx7foWGm5fo/0.jpg)](https://www.youtube.com/watch?v=Cx7foWGm5fo)  
*Watch on YouTube: [ARP - The Address Resolution Protocol](https://www.youtube.com/watch?v=Cx7foWGm5fo)

---

## IP-paketi √ºlesehitus

IP-pakett on v√µrguliikluse p√µhi√ºksus, mis koosneb kahest peamisest osast:

**IP-paketi p√§is**
- Versiooninumber (IPv4 v√µi IPv6)
- Paketi pikkus baitides
- TTL (Time To Live) - eluiga v√µrgus
- Protokollikood transpordiprotokolli m√§√§ramiseks
- Kontrollsumma vigade tuvastamiseks
- L√§hte- ja sihtkoha IP-aadressid

**IP-paketi andmeosa**
- Sisaldab edastatavaid andmeid
- Maksimaalne suurus s√µltub v√µrgu MTU-st
- Vajadusel fragmenteeritakse v√§iksemateks osadeks

Teen IP paketi v√§ljade selgituse tabelina ja lisan ka visuaalse struktuuri:

## IPv4 Packet Header

![IP Packet Header Fields](https://networklessons.com/wp-content/uploads/2015/07/ip-packet-header-fields.png)  
*Image Source: [NetworkLessons - IP Packet Header Fields](https://networklessons.com)*


## IP Paketi V√§ljade Tabel

| V√§li | Suurus | V√§√§rtused | Kirjeldus |
|------|---------|-----------|-----------|
| Version | 4 bitti | 4 | IPv4 versiooninumber |
| Header Length (IHL) | 4 bitti | 5-15 | P√§ise pikkus 32-bitistes √ºhikutes (min 20B, max 60B) |
| Type of Service | 8 bitti | - | QoS m√§rgistus paketi prioriteedi m√§√§ramiseks |
| Total Length | 16 bitti | 20-65535 | Kogu paketi suurus baitides (p√§is + andmed) |
| Identification | 16 bitti | - | Fragmentide grupeerimise ID |
| Flags | 3 bitti | - | Fragmenteerimise kontrollbitid |
| Fragment Offset | 13 bitti | - | Fragmendi positsioon originaalpaketis |
| Time to Live | 8 bitti | 0-255 | Maksimaalne lubatud hopide arv |
| Protocol | 8 bitti | - | J√§rgmise kihi protokoll (TCP=6, UDP=17) |
| Header Checksum | 16 bitti | - | P√§ise kontrollsumma vigade tuvastamiseks |
| Source IP | 32 bitti | - | L√§htekoha IP aadress |
| Destination IP | 32 bitti | - | Sihtkoha IP aadress |
| Options | Muutuv | - | Valikulised lisav√§ljad |

## Flags (Lipud)

| Bitt | Nimi | Kirjeldus |
|------|------|-----------|
| 0 | Reserveeritud | Alati 0 |
| 1 | DF (Don't Fragment) | 1 = √Ñra fragmenteeri |
| 2 | MF (More Fragments) | 1 = J√§rgnevad veel fragmendid |

### N√§ide: "Don't Fragment" Biti Testimine Windowsis

```bash
ping -f -l 2000 hkhk.edu.ee
```

#### Selgitus:
- `-f`: M√§√§rab "Don't Fragment" (√Ñra Fragmenteeri) biti
- `-l 2000`: Paketi suurus baitides (antud juhul 2000)

#### V√§ljund:
- **Edukas:**
```
Reply from [IP]: bytes=2000 time=XXms TTL=XX
```
- **Eba√µnnestunud:**
```
Packet needs to be fragmented but DF set.
```

> üí° **N√µuanne:** See test aitab tuvastada MTU probleeme v√µrgus. Kui test eba√µnnestub, on paketi suurus suurem kui v√µrgu MTU.

## Levinumad Protokollikoodid

| Protokoll | V√§√§rtus | Kasutus |
|-----------|---------|---------|
| ICMP      | 1       | V√µrgu kontrolli- ja veateated |
| TCP       | 6       | Usaldusv√§√§rne andmeedastus |
| UDP       | 17      | Kiire, kontrollimata andmeedastus |

[RFC 1700 - Assigned Numbers](https://www.rfc-editor.org/rfc/rfc1700.html), [Wikipedia: List of IP Protocol Numbers](https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers)

![Wireshark Capture - IP Header Fields](https://networklessons.com/wp-content/uploads/2015/07/wireshark-capture-ip-header-fields.png)  
*Image Source: [NetworkLessons - Wireshark Capture of IP Header Fields](https://networklessons.com)*


## Time To Live (TTL)

TTL (Time To Live) on IP paketi eluea m√§√§raja, mis takistab pakettide l√µputut ringlemist v√µrgus. Iga v√µrguseade (ruuter), mis paketti edastab, v√§hendab TTL v√§√§rtust √ºhe v√µrra.

### Tavaline Ping Google'ile

```bash
# Windows
C:\> ping google.com

Pinging google.com [142.250.74.110] with 32 bytes of data:
Reply from 142.250.74.110: bytes=32 time=15ms TTL=115
Reply from 142.250.74.110: bytes=32 time=14ms TTL=115
Reply from 142.250.74.110: bytes=32 time=15ms TTL=115
Reply from 142.250.74.110: bytes=32 time=14ms TTL=115
```

```mermaid
sequenceDiagram
    participant C as Arvuti<br/>(TTL=128)
    participant R1 as Ruuter 1<br/>(TTL=127)
    participant R2 as Ruuter 2<br/>(TTL=126)
    participant G as Google<br/>(TTL=115)
    
    C->>R1: ICMP Echo (Ping)
    Note over C,R1: TTL v√§heneb: 128->127
    R1->>R2: ICMP Echo
    Note over R1,R2: TTL v√§heneb: 127->126
    R2->>G: ICMP Echo
    Note over R2,G: TTL j√µuab kohale<br/>v√§√§rtusega 115
    G->>C: ICMP Reply
```

### TTL=1 Ping N√§ide (Pakett Sureb)

```bash
# Linux/Mac
$ ping -t 1 google.com

PING google.com (142.250.74.110) 56(84) bytes of data.
From router.local (192.168.1.1) icmp_seq=1 Time to live exceeded
From router.local (192.168.1.1) icmp_seq=2 Time to live exceeded
From router.local (192.168.1.1) icmp_seq=3 Time to live exceeded
```

```mermaid
sequenceDiagram
    participant C as Arvuti<br/>(TTL=1)
    participant R1 as Ruuter 1<br/>(TTL=0)
    participant R2 as Ruuter 2
    participant G as Google
    
    C->>R1: ICMP Echo (Ping)<br/>TTL=1
    Note over R1: TTL v√§heneb 1->0<br/>Pakett sureb!
    R1-->>C: ICMP Time Exceeded<br/>"TTL expired in transit"
    Note over C,R1: Pakett ei j√µua kunagi<br/>sihtpunkti
```

### TTL Vaikev√§√§rtused Erinevates Operatsioonis√ºsteemides

| Operatsioonis√ºsteem | Vaikimisi TTL |
|---------------------|---------------|
| Windows | 128 |
| Linux | 64 |
| macOS | 64 |
| Cisco IOS | 255 |

### Miks TTL On Oluline?

1. **V√µrguts√ºklite V√§ltimine**
   - Kaitseb v√µrku l√µputute marsruutimists√ºklite eest
   - V√§ldib v√µrgu √ºlekoormust vigase konfiguratsiooni korral

2. **V√µrgu Diagnostika**
   - `traceroute` k√§sk kasutab TTL-i marsruudi kaardistamiseks
   - Aitab tuvastada v√µrguprobleemide asukohta

3. **V√µrgu Turvalisus**
   - Piirab pahatahtlike pakettide levikut v√µrgus
   - Aitab tuvastada v√µrgutopograafiat

## IP Fragmentatsioon

```mermaid
sequenceDiagram
    participant S as Saatja
    participant R1 as Router 1<br/>(MTU: 1500)
    participant R2 as Router 2<br/>(MTU: 576)
    participant V as Vastuv√µtja
    
    Note over S,V: Suur pakett (2000 baiti)
    S->>R1: T√§ispakett
    Note over R1: MTU kontroll
    R1->>R2: Fragment 1 (576 baiti)
    R1->>R2: Fragment 2 (576 baiti)
    R1->>R2: Fragment 3 (848 baiti)
    R2->>V: Fragment 1
    R2->>V: Fragment 2
    R2->>V: Fragment 3
    Note over V: Paketi kokkupanek
```

IP-fragmentatsioon on protsess, kus suured andmepaketid jagatakse v√§iksemateks osadeks:

**Fragmentatsiooni p√µhjused:**
- V√µrgu MTU (Maximum Transmission Unit) piirang
- Erinevad v√µrguseadmed v√µivad toetada erinevaid MTU suurusi
- Tagab andmete edastamise l√§bi piiratud l√§bilaskev√µimega v√µrkude

![IPv‚Ç¨ Fragmentation](https://kagi.com/proxy/PDU_Fragmentation-en.png?c=9cn5Kxse4yD05EJkf6QML9dK4clUbdQ9Oq4d5gDoyHCCz2LSIiDgRFpKVUE3WPuRqKYtAXfCaHtm4NdWncWlciUEW6gJQClHrPvovJIY5i87Dx2w8csR-M7iJsv9P0uE)  

**Fragmentatsiooni protsess:**
1. Algne pakett jagatakse v√§iksemateks osadeks
2. Iga fragment saab unikaalse identifikaatori
3. Sihtkohas fragmendid tuvastatakse ja pannakse √µiges j√§rjekorras kokku
4. Kui m√µni fragment puudub, tuleb kogu pakett uuesti saata

**M√§rkused:**
- Fragmentatsioon v√µib suurendada v√µrgu koormust
- V√µib p√µhjustada viivitusi andmeedastuses
- Moodsad v√µrgud p√º√ºavad fragmentatsiooni v√§ltida Path MTU Discovery mehhanismi abil

---

### IP P√µhiomadused

* IP t√∂√∂tab ilma loogiliste √ºhenduste loomiseta hostide vahel: see kasutab aadresse, mis on paigutatud IP-paketi p√§isesse, et edastada pakette nende saajateni. **Edastustee valik nimetatakse marsruutimiseks.**

* IP kasutab p√§ise v√§lju datagrammide **fragmenteerimiseks ja taastamiseks**, kui see on vajalik nende edastamiseks l√§bi v√§ikese paketisuurusega v√µrkude.

* **Andmete k√§ttesaamise kinnitust ei n√µuta.** See t√§hendab, et saatjat ja vastuv√µtjat ei teavitata paketi kadumisest v√µi pakettide vale j√§rjekorra vastuv√µtmisest.

### Marsruutimise protsess
Kui IP tuvastab, et sihtkoha aadress on lokaalne, saadetakse pakett otse sihtkoha hostini. Vastasel juhul:
- Kontrollitakse marsruutimistabelit marsruudi olemasolu kohta sihtkoha hostini
- Kui marsruut leitakse, edastatakse pakett leitud marsruudi j√§rgi
- Vastasel juhul saadetakse pakett vaikimisi l√º√ºsi (default gateway) kaudu

```mermaid
graph TB
    subgraph "Marsruutimise Protsess"
        E{Is destination<br>address local?}
        F{Route exists in<br>routing table?}
        G[Send directly to<br>destination host]
        H[Forward packet<br>via found route]
        I[Send via<br>default gateway]
        
        E -->|Yes| G
        E -->|No| F
        F -->|Yes| H
        F -->|No| I
    end
```

![Default Gateway Diagram](./media/Default-Gateway-Computer-needs-to-send-a-data-transmission.png) 

## üí° K√ºsimus

**Kuidas ma saan Google'i MAC-aadressi teada?**

## UDP (User Datagram Protocol) - Kasutaja Datagrammi Protokoll

V√§ike vihje: UDP-d on lihtsam "vaikida hetkeks" kui pidevalt midagi k√ºsida (nagu teeb TCP).

![UDP Joke](https://i.redd.it/w1z4plla5o571.jpg)


*Miks nii?* UDP lihtsalt saadab andmeid k√ºsimata, kas need kohale j√µudsid. See on nagu r√§√§kimine - sa ei k√ºsi iga s√µna j√§rel "Kas sa said aru?", vaid lihtsalt r√§√§gid edasi. 

UDP on lihtne, kompaktne ja v√§ga kiire protokoll, mille IP-identifikaator on 17 (0x11). Selle transporditaseme protokolli eesm√§rk on andmete edastamine rakenduste vahel ilma garanteeritud kohaletoimetamiseta. See ei loo loogilist √ºhendust, ei nummerda ega j√§rjesta pakette.

Peamised omadused:
- Ei taga andmete kadumise v√§ltimist edastamisel
- Ei taga datagrammide √µiget j√§rjestust vastuv√µtmisel
- Ei taga s√µnumite dubleerimise v√§ltimist
- Omab lihtsat teostust
- Omab k√µrget t√∂√∂kiirust
- Sobib kasutamiseks usaldusv√§√§rsetes kanalites
- Kasutatakse reaalajas liikluse edastamiseks (h√§√§l, video)

## UDP-paketi formaat (UDP Packet Format)

UDP andme√ºhik koosneb UDP p√§isest (header) ja andmev√§ljast (data field), mis sisaldab rakenduskihi paketti.

![UDP paketi struktuur](https://image2.slideserve.com/4379477/udp-format-l.jpg)

Olulised detailid:
- Esimesed 8 baiti moodustavad UDP p√§ise, millele j√§rgnevad s√µnumi andmed
- Datagrammi pikkuse v√§li n√§itab kogu UDP-s√µnumi pikkust, kaasa arvatud UDP p√§is
- M√µ√µdetakse baitides

Maksimaalsed suurused:
- UDP-datagrammi maksimaalne pikkus (ilma minimaalse IP p√§iseta): 65535 - 20 = 65515 baiti
- Maksimaalne andmete pikkus UDP-s√µnumis: 65515 - 8 = 65507 baiti

![UDP Wireshark Screenshot](https://i.sstatic.net/noJgy.png)

## UDP protokolli kasutamine ja tuntud pordid (UDP Protocol Usage and Well-Known Ports)

UDP protokolli kasutatakse j√§rgmistel juhtudel:
- Kui edastatavate andmete maht on nii v√§ike, et √ºhenduse loomise ja usaldusv√§√§rsuse j√§lgimise kulud oleksid suuremad kui k√µigi andmete uuesti saatmine
- P√§ring-vastus t√º√ºpi rakendustes, kus vastust saab lugeda p√§ringu k√§ttesaamise kinnituseks
- Rakendustes, kus on olemas oma meetodid andmete usaldusv√§√§rse edastamise tagamiseks ja seda ei n√µuta transpordiprotokollidelt

RFC-1700 (1994) standardist m√µned m√§√§ratud pordid:
| Port | Protokoll | Teenus | Kirjeldus |
|------|-----------|---------|-----------|
| 53 | UDP/TCP | DNS | Domeeninimed |
| 67 | UDP | bootps | BOOTP ja DHCP - server |
| 68 | UDP | bootps | BOOTP ja DHCP - klient |
| 69 | UDP | tftp | Lihtsustatud failiedastus |
| 161 | UDP | SNMP | Haldusprotokooll |

*Praktiline n√§ide:* DNS kasutab porti 53, sest kiire p√§ring-vastus mudel on t√µhusam kui t√§ieliku TCP √ºhenduse loomine iga p√§ringuga.

## **Transpordikiht** (**L4**). **Usaldusv√§√§rse andmeedastuse protokoll** (**TCP**)

Usaldusv√§√§rse andmeedastuse tagamiseks transpordikihis kasutatakse **TCP** protokolli (**Transmission Control Protocol**) ‚Äì **usaldusv√§√§rne vooprotokoll**, mis n√µuab **loogiliste √ºhenduste** loomist.

TCP usaldusv√§√§rsus tagatakse **positiivse kinnituse ja taasedastuse mehhanismiga** (**Positive Acknowledgment with Retransmission**, **PAR**). PAR-s√ºsteem kordab andmete saatmist seni, kuni saajalt saabub kinnitus andmete k√§ttesaamise kohta.

Andmeid edastatakse **baidivoogudena** (**Flow**) ja neid saab edastada m√µlemas suunas.

TCP suhtlevate moodulite andmevahetuse p√µhi√ºksuseks on **segment** (**Segment**).

Iga segment sisaldab **j√§rjekorranumbrit** voos ja **kontrollsummat**, mille abil saaja kontrollib andmete terviklikkust.

## **TCP-√ºhenduse l√µpp-punktid ja √ºhenduse loomine**

**Sokkel** (Socket) on abstraktne objekt, mis esindab √ºhenduse l√µpp-punkte. **Sokkel** on programmiline liides, mis tagab andmevahetuse protsesside vahel.

```mermaid
graph LR
    subgraph Server[Google.com Server Cluster]
        G1[[Server 1]]
        G2[[Server 2]]
        G3[[Server 3]]
        IP[172.217.23.142]
    end
    
    subgraph Socket_Listen
        SL((Socket Listen\n172.217.23.142:80))
    end
    
    subgraph Clients
        C1[Client 1\n212.164.17.201]
        C2[Client 2\n152.33.100.67]
        C3[Client 3\n88.132.1.121]
    end
    
    subgraph Socket_Connect
        SC1((Socket Connect\n172.217.23.142:80))
        SC2((Socket Connect\n172.217.23.142:80))
        SC3((Socket Connect\n172.217.23.142:80))
    end
    
    subgraph Connection_IDs[Active Connection IDs]
        ID1[172.217.23.142:80 212.164.17.201:25467]
        ID2[172.217.23.142:80 152.33.100.67:64571]
        ID3[172.217.23.142:80 88.132.1.121:16321]
    end
    
    G1 & G2 & G3 --> IP --> SL
    
    SL -->|TCP Flow\nSegment| SC1
    SL -->|TCP Flow\nSegment| SC2
    SL -->|TCP Flow\nSegment| SC3
    
    SC1 -->|Port:25467| C1
    SC2 -->|Port:64571| C2
    SC3 -->|Port:16321| C3
    
    classDef server fill:#f9f,stroke:#333,stroke-width:2px
    classDef socket fill:#9f9,stroke:#333,stroke-width:2px
    classDef client fill:#fff,stroke:#333,stroke-width:2px
    classDef ids fill:#fff,stroke:#f00,stroke-width:2px
    
    class G1,G2,G3 server
    class SL,SC1,SC2,SC3 socket
    class C1,C2,C3 client
    class ID1,ID2,ID3 ids
```

## TCP √úhenduse olekud

### Peamised olekud:

| Olek           | Kirjeldus                                                                 |
|-----------------|--------------------------------------------------------------------------|
| **LISTEN**      | Server ootab sissetulevaid √ºhendusi. Sokkel on valmis √ºhendusi vastu v√µtma. |
| **ESTABLISHED** | √úhendus on aktiivne. Toimub andmevahetus. V√µimalik kahepoolne suhtlus.   |
| **TIME_WAIT**   | Ootab, et tagada FIN-paketi j√µudmine sihtpunkti. Vaikimisi ooteaeg: 2 MSL (Maximum Segment Life). |
| **CLOSED**      | √úhendus on t√§ielikult l√µpetatud. Ressursid on vabastatud.                |


### Netstat k√§sk √ºhenduste vaatamiseks:
```bash
netstat -n
```
```
Proto Recv-Q Send-Q Local Address           Foreign Address         State
tcp        0      0 172.217.23.142:80       212.164.17.201:25467   ESTABLISHED
tcp        0      0 172.217.23.142:80       152.33.100.67:64571    ESTABLISHED
tcp        0      0 172.217.23.142:80       88.132.1.121:16321     ESTABLISHED
```

Need on k√µige tavalisemad olekud, mida v√µib n√§ha TCP √ºhenduste j√§lgimisel.

## TCP √úhenduse l√µpp-punktid

## L√µpp-punkti definitsioon
√úhenduse l√µpp-punkt koosneb kahest komponendist:
```
<s√µlm> : <port>
```
kus:
- `<s√µlm>` - v√µrgus√µlme IP-aadress
- `<port>` - antud s√µlme TCP pordi number

## √úhenduste identifitseerimine

- Iga √ºhendus identifitseeritakse kahe l√µpp-punkti paariga
- √úks l√µpp-punkt v√µib osaleda mitmes √ºhenduses
- Segadust ei teki, kuna TCP protokollis on k√µik √ºhendused seotud konkreetse l√µpp-punktide paariga, mitte ainult pordi numbritega

## Loogiline √ºhendus

TCP protokoll n√µuab loogilise √ºhenduse loomist, mis t√§hendab eelnevat "kokkulepet" kahe arvuti l√µpp-punktide vahel. Need "l√§bir√§√§kimised" toimuvad rakenduste vahel, mis k√§ivitatakse arvutites, mille vahel √ºhendus luuakse:

### Passiivne √ºhenduse loomine (Listen)
- √úks rakendus teostab passiivse √ºhenduse avamise funktsiooni (Listen)
- Annab teada, et on valmis sissetulevaid √ºhendusi vastu v√µtma
- P√§rast seda m√§√§rab operatsioonis√ºsteem TCP-pordi numbri antud √ºhenduse jaoks

### Aktiivne √ºhenduse loomine (Connect)
- Teine rakendus, mis t√∂√∂tab virtuaalse kanali teises otsas, p√∂√∂rdub operatsioonis√ºsteemi poole aktiivse √ºhenduse avamise taotlusega (Connect)


# TCP Segmendi P√§is (TCP Segment Header)

![IP packets carry TCP segments](https://www.oreilly.com/api/v2/epubs/1565925092/files/httpatomoreillycomsourceoreillyimages96904.png)

*IP packets carry TCP segments, which carry chunks of the TCP data stream.*

**Source:** [O'Reilly Media](https://www.oreilly.com/api/v2/epubs/1565925092/files/httpatomoreillycomsourceoreillyimages96904.png)


## V√§ljad:

## TCP Segmendi P√µhiv√§ljad (TCP Segment Main Fields)

| V√§li (eesti) | V√§li (inglise) | Bittide asukoht | Kirjeldus |
|--------------|----------------|-----------------|------------|
| Saatja port | Source Port | 0-15 | Pordi number arvutist-saatjast |
| Vastuv√µtja port | Destination Port | 16-31 | Pordi number arvutist-vastuv√µtjast |
| J√§rjekorranumber | Sequence Number (SN) | | Kasutatakse fragmentide kokkupanekuks |
| Kinnituse number | Acknowledgment Number (AS=SN+1) | | Paketi vastuv√µtu kinnituse number |
| P√§ise pikkus | TCP Header Length | | M√§√§rab TCP p√§ise pikkuse |
| Kontrollsumma | Checksum | | Andmete terviklikkuse kontroll |
| Lisaparameetrid | Additional Parameters | | Muutuva pikkusega v√§li |

### TCP/IP Kapseldamine (Encapsulation):
```
[ ... | IP | TCP | ... ]
```

## TCP Segmendi Kontrollbittide ja V√§ljad

### Reserveeritud v√§li (Reserved)
- Reserveeritud tulevikus kasutamiseks

### Kontrollbitid (Code bits)
| Bitt | Nimetus | Kirjeldus |
|------|----------|-----------|
| URG | Kiireloomuline | Kiireloomulise s√µnumi m√§rgis |
| ACK | Kinnitus | Segmendi vastuv√µtu kinnitus |
| PSH | Push | M√§rgib puhvri kohest t√ºhjendamist |
| RST | Reset | √úhenduse taastamise p√§ring |
| SYN | S√ºnkroniseerimine | Kasutatakse andmeloendurite s√ºnkroniseerimiseks √ºhenduse loomisel |
| FIN | L√µpetamine | M√§rgib viimase baidi saavutamist andmevoos |

### T√§iendavad v√§ljad
| V√§li | Kirjeldus |
|------|-----------|
| Window | Vastuv√µetavate plokkide arv vastuv√µtja poolt |
| Checksum | Kontrollsumma p√§ise ja andmepaketi terviklikkuse kontrolliks |
| Urgent pointer | URG bitiga koos n√§itab kiireloomuliste andmete l√µppu, ignoreerides puhvri t√§itumist |
| Options | Muutuva pikkusega v√§li lisafunktsioonide jaoks (nt maksimaalse segmendi suuruse m√§√§ramiseks) |
| Padding | T√§itev√§li p√§ise suuruse viimiseks 32-bitiste s√µnade t√§isarvuni |

## TCP Kolmepoolne K√§epigistus (Three-way Handshake)

Kaks poolt s√ºnkroniseerivad baitide nummerdamise s√ºsteemid, vahetades SYN-segmente k√§epigistuse k√§igus. √úhendus initsialiseeritakse kolme andmevahetusega.

![Connection Establishment using Three-Way Handshaking](https://i.sstatic.net/y17TW.png)

**Source:** [Connection establishment](https://i.sstatic.net/y17TW.png)


### √úhenduse loomise etapid:
1. **Aktiivne avamine**
   - Klient ‚Üí Server: SYN_SENT
   - Saadetakse SYN J

2. **Passiivne avamine**
   - Server ‚Üí Klient: SYN_RCVD
   - Saadetakse SYN K, ACK J+1

3. **√úhenduse kinnitamine**
   - Klient ‚Üí Server: ESTABLISHED
   - Saadetakse ACK K+1

### √úhenduse l√µpetamise etapid:
1. **Aktiivne sulgemine**
   - FIN_WAIT_1
   - FIN_WAIT_2
   - TIME_WAIT
   
2. **Passiivne sulgemine**
   - CLOSE_WAIT
   - LAST_ACK
   - CLOSE

### ‚ùó TCP J√§rjenumber

TCP kasutab **j√§rjenumbreid**, et tagada andmevoo terviklikkus ja √µige j√§rjekord. Selle abil saab vastuv√µtja kontrollida, kas k√µik andmepaketid on kohale j√µudnud ja √µiges j√§rjekorras. üöÄ

---

### üìñ **N√§ide**

#### **Olukord:**
Sul on tekstifail, mille suurus on **6000 baiti**. üñ•Ô∏è TCP jagab faili v√§iksemateks t√ºkkideks (pakettideks), kus iga pakett sisaldab **1000 baiti**.

#### **Pakettide J√§rjenumbrid:**
- üì¶ **Pakett 1:** J√§rjenumber **0‚Äì999**
- üì¶ **Pakett 2:** J√§rjenumber **1000‚Äì1999**
- üì¶ **Pakett 3:** J√§rjenumber **2000‚Äì2999**
- üì¶ Jne...

---

### üéØ **Kuidas see toimib?**
1. **üì§ Saatmine:** TCP saadab paketid vastuv√µtjale √ºkshaaval.
2. **üîç Vastuv√µtt ja kontroll:** Vastuv√µtja ootab n√§iteks paketti j√§rjenumbriga **1000‚Äì1999**. Kui j√§rgmine pakett h√ºppab otse **2000‚Äì2999** peale, saab ta aru, et pakett **2** on kadunud. ‚ùå
3. **‚úÖ Kinnitus (ACK):** Vastuv√µtja saadab kinnituse: "Olen saanud kuni **999**." Saatja edastab uuesti puuduva paketi.

---

### üìö **Reaalse Elu Analoogia**

Kujuta ette, et saadad s√µbrale raamatu **lehek√ºlgede vahemikega**:
- üìÑ **Leht 1:** **1‚Äì100 s√µna**
- üìÑ **Leht 2:** **101‚Äì200 s√µna**
- üìÑ **Leht 3:** **201‚Äì300 s√µna**

Kui s√µber saab ainult:
- **Leht 1:** **1‚Äì100**
- **Leht 3:** **201‚Äì300**, 

siis ta kirjutab: "üì¨ *Palun saada uuesti vahemik **101‚Äì200**!*"  
P√§rast seda on k√µik korras. ‚úÖ

---

### ü§î **Miks see oluline on?**
- üéØ TCP tagab, et k√µik andmed saabuvad tervikuna ja √µigel ajal. 
- üö® Kui midagi l√§heb valesti, korrigeeritakse see automaatselt.

**Ja voil√†! TCP tagab t√§iusliku andmevoo, isegi kui teel on segadus.** üéâ

![Data Transfer](https://www.researchgate.net/profile/Abbas-Miry/publication/340247809/figure/fig1/AS:873937277837312@1585374292225/Data-transfer.jpg)

**Source:** [Data transfer process](https://www.researchgate.net/profile/Abbas-Miry/publication/340247809/figure/fig1/AS:873937277837312@1585374292225/Data-transfer.jpg)

![Connection Termination using Three-Way Handshaking](https://www.researchgate.net/profile/Abbas-Miry/publication/340247809/figure/fig2/AS:873937277825026@1585374292255/Connection-termination-using-three-way-handshaking.ppm)

**Source:** [Connection Termination](https://www.researchgate.net/profile/Abbas-Miry/publication/340247809/figure/fig2/AS:873937277825026@1585374292255/Connection-termination-using-three-way-handshaking.ppm)

---

## ICMP (Internet Control Message Protocol) ‚ú®

**L√ºhidalt:** ICMP on IP-protokolli osa, mille eesm√§rk on v√µrgus esinevate vigade ja erijuhtude kohta teada anda. See ei ole andme√ºhendusprotokoll, vaid kontrolls√µnumite jaoks loodud mehhanism. ICMP on osa IP-paketi p√§isest ‚Äì natuke nagu tagasiside mehhanism! üìä

![Internet Control Message Protocol (ICMP)](https://service.snom.com/download/attachments/234345581/image2018-7-25_9-39-39.png?version=1&modificationDate=1710679553976&api=v2)


### Kuidas ICMP t√∂√∂tab? üî¢
ICMP s√µnum koosneb:
- **T√º√ºp (Type):** S√µnumi olemus (nt Ping-p√§ring). üîç
- **Kood (Code):** T√º√ºbi detailid. üîë
- **Kontrollsumma:** Veakontroll. ‚úîÔ∏è
- **Andmed:** V√µib sisaldada algset IP-paketi p√§ist, et vea allikat tuvastada. üïµÔ∏è

### Levinud ICMP t√º√ºbid ja koodid ‚ú®
| **T√º√ºp** | **Kood** | **Kirjeldus**             |
|----------|----------|---------------------------|
| 0        | 0        | Eho-vastus (Ping vastus)  |
| 3        | 0        | V√µrk pole k√§ttesaadav     |
| 3        | 1        | Seade pole k√§ttesaadav    |
| 8        | 0        | Eho-p√§ring (Ping p√§ring)  |
| 11       | 0        | Aegumise teade (TTL = 0)  |

### Milleks ICMP? ‚ùì
- **Ping:** Kontrollib, kas host vastab ja kui kiiresti. ‚è≥
- **Traceroute:** J√§lgib teekonda sihtkohta ja toob v√§lja v√µrguprobleemid. üåê

![Ping](https://cammyd.com/wp-content/uploads/2014/09/pinggoogle.png)

![Wireshark ICMP Ping Sweep](https://www.infosecmatter.com/wp-content/uploads/2021/05/wireshark-icmp-ping-sweep.jpg)


### Pingi p√µhim√µte üöÄ
1. Saadetakse ICMP eho-p√§ring (**t√º√ºp 8, kood 0**). ‚§¥Ô∏è
2. Vastusena saadakse eho-vastus (**t√º√ºp 0, kood 0**). üåê
3. Arvutatakse edasi-tagasi teekonna aeg (RTT). üìÖ

### Fun Fakt: Kust tuli ‚ÄûPing‚Äù nimi? üéß
See sai inspiratsiooni allveelaevade sonarist (‚Äûping‚Äù heli!), mida kuuleb tihti filmides. Idee oli, et s√µnum l√§heb ‚Äûv√§lja‚Äù ja tuleb tagasi, nagu sonarilaine. üö¢

---

## üòÇ **Jokes from OSI to ICMP** üåê

![Ping Image](https://www.m00nie.com/content/images/size/w2000/2020/03/ping.jpg)

- **"I know a great joke about UDP, but it's not guaranteed to reach you."** üì¨  
- **"I know a great joke about TCP, and if it doesn‚Äôt reach you, I‚Äôll tell it again."** üîÅ 
- **"Did you reply to the ICMP joke?"** üì®  

![ICMP Joke Meme](https://www.memecreator.org/static/images/memes/4866203.jpg)
